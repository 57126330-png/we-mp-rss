# 开发注意事项 - 避免影响生产数据库

## ⚠️ 重要警告

**本项目的生产环境使用 Supabase Free（最大 20 个连接限制）。**

**开发时必须注意：不要对生产环境进行大量测试，否则会导致数据库连接耗尽，服务卡死！**

## 📋 核心原则

### 1. 永远不要对生产环境进行大量测试

**禁止行为**：
- 对生产环境的 API 进行大量并发请求
- 使用压力测试工具对生产环境进行测试
- 在开发/测试代码中循环调用生产环境的 API
- 使用自动化测试脚本对生产环境进行批量测试

**正确做法**：
- 使用本地开发环境进行所有测试
- 使用测试数据库（非生产环境）
- 如果必须测试生产环境，严格限制并发数（建议 < 5）
- 在开发代码中添加请求限流和延迟

### 2. 使用本地/测试数据库

**重要**：
- 开发时必须使用独立的测试数据库
- 不要使用生产环境的数据库连接字符串
- 不要在生产数据库上进行任何开发操作
- 确保开发环境的数据库配置与生产环境分离

**数据库选择**：
- 可以使用任何你熟悉的数据库（SQLite、MySQL、PostgreSQL 等）
- 关键是使用独立的测试数据库，不要影响生产环境

### 3. 正确管理数据库连接

**核心问题**：
- 每个数据库连接都需要在使用后正确释放
- 未释放的连接会累积，最终耗尽数据库连接池
- 大量并发请求会放大这个问题

**必须注意**：
- 确保每个数据库操作后，连接都被正确关闭
- 使用连接池时，确保连接在使用后返回到连接池
- 避免长时间持有数据库连接
- 在异常情况下也要确保连接被释放

## 🔧 代码修改注意事项

### Session/Connection 管理（关键）

**如果你修改或添加新的 API 端点，必须注意：**

#### 必须做到：
1. **每个数据库操作后都要释放连接**
   - 无论是查询还是写入操作
   - 无论操作成功还是失败
   - 无论是否发生异常

2. **使用事务管理机制**
   - 确保事务正确提交或回滚
   - 事务结束后释放连接

3. **异常处理中也要释放连接**
   - 在 try-catch 的 finally 块中释放
   - 确保异常情况下连接不会泄漏

4. **避免长时间持有连接**
   - 不要在请求处理过程中长时间持有连接
   - 不要在等待外部服务时持有连接

#### 常见错误：
1. **获取连接后忘记释放**
   - 只获取连接，使用后不释放
   - 导致连接泄漏

2. **异常情况下不释放连接**
   - 只在正常流程中释放连接
   - 异常发生时连接泄漏

3. **混用不同的连接管理方式**
   - 在一个项目中混用多种连接管理方式
   - 导致某些连接没有被正确管理

4. **并发请求时连接数失控**
   - 没有限制并发数
   - 大量请求同时创建连接，超过数据库限制

### 连接池配置

**本项目会根据数据库类型自动配置连接池：**

- **SQLite**：最小连接池配置（不需要连接池）
- **MySQL**：中等连接池配置（最大约 15 个连接）
- **PostgreSQL/Supabase**：保守连接池配置（最大 15 个连接，留有余量）

**重要**：
- 即使有连接池保护，也要避免大量并发请求
- 连接池只是缓解问题，不是解决方案
- 生产环境（Supabase Free）只有 20 个连接限制，必须谨慎

## 🧪 测试最佳实践

### 1. 本地开发环境

**必须设置**：
- 独立的测试数据库
- 与生产环境完全隔离的配置
- 本地开发服务器

**测试流程**：
- 所有功能测试都在本地环境进行
- 确认功能正常后再考虑生产环境验证
- 生产环境验证时也要限制请求量

### 2. 并发测试限制

**本地测试**：
- 可以适当进行并发测试
- 但也要注意不要超过本地数据库的限制
- 建议并发数不超过 10

**生产环境测试**：
- **严格禁止大量并发测试**
- 如果必须测试，并发数限制在 5 以下
- 测试间隔要足够长，避免连接累积

**压力测试**：
- 只能在本地环境进行
- 永远不要对生产环境进行压力测试

### 3. 自动化测试注意事项

**如果使用自动化测试**：
- 确保测试环境使用独立的测试数据库
- 测试脚本中要限制并发数
- 测试之间要有适当的延迟
- 不要将生产环境的 API 地址硬编码到测试脚本中

**CI/CD 测试**：
- 使用独立的测试数据库
- 不要在生产环境上运行 CI/CD 测试
- 测试完成后确保所有连接都被释放

## 🚨 常见错误和避免方法

### 错误 1：对生产环境进行压力测试

**问题**：
- 大量并发请求快速消耗数据库连接
- 超过数据库连接限制（Supabase Free 只有 20 个）
- 导致数据库卡死，服务不可用
- 影响所有用户

**避免方法**：
- 只在本地环境进行压力测试
- 如果必须测试生产环境，严格限制并发数
- 使用本地数据库进行所有开发测试

### 错误 2：忘记释放数据库连接

**问题**：
- 每个未释放的连接都会占用数据库资源
- 大量请求后，连接数累积
- 最终耗尽所有可用连接
- 新请求无法获取连接，服务卡死

**避免方法**：
- 使用连接管理机制（连接池、上下文管理器等）
- 确保每个连接都有对应的释放逻辑
- 在异常处理中也释放连接
- 代码审查时检查连接管理

### 错误 3：使用生产数据库进行开发

**问题**：
- 开发时的错误操作可能影响生产数据
- 大量测试请求会耗尽生产数据库连接
- 可能影响生产服务的稳定性

**避免方法**：
- 使用独立的测试数据库
- 开发环境配置与生产环境完全分离
- 永远不要在生产数据库上开发

### 错误 4：没有限制并发数

**问题**：
- 大量并发请求同时创建连接
- 快速超过数据库连接限制
- 即使有连接池也无法应对

**避免方法**：
- 在代码中添加并发限制
- 使用队列或限流机制
- 测试时也要限制并发数

### 错误 5：长时间持有连接

**问题**：
- 在处理请求时长时间持有数据库连接
- 等待外部服务时也不释放连接
- 导致连接利用率低，但占用资源

**避免方法**：
- 尽快完成数据库操作并释放连接
- 不要在等待外部服务时持有连接
- 使用异步操作时也要注意连接管理

## 📊 监控和验证

### 如何检查连接数

**如果使用 PostgreSQL**：
- 查看数据库的活动连接数
- 正常情况下应该远低于最大限制

**如果使用 MySQL**：
- 查看数据库的进程列表
- 检查连接数是否正常

**Supabase**：
- 在 Supabase 控制台查看连接数
- 正常情况下应该 < 15 个连接（留有余量）

### 如何验证修复效果

**启动服务时**：
- 查看日志中的连接池配置信息
- 确认配置是否正确应用

**测试 API**：
- 测试关键 API 是否正常响应
- 观察响应时间是否正常
- 检查是否有连接相关的错误

**监控连接数**：
- 持续监控数据库连接数
- 确认连接数稳定，不会持续增长
- 大量请求后连接数应该恢复正常

## 🔍 代码审查检查清单

**在提交代码前，必须检查：**

- [ ] 所有数据库连接都有对应的释放逻辑
- [ ] 异常情况下也会释放连接
- [ ] 没有对生产环境进行大量测试的代码
- [ ] 使用了独立的测试数据库
- [ ] 测试代码限制了并发数
- [ ] 没有长时间持有连接的情况
- [ ] 连接管理方式统一，没有混用

## 📝 开发工作流

### 推荐的开发流程

1. **设置开发环境**
   - 配置独立的测试数据库
   - 确保与生产环境隔离

2. **本地开发**
   - 在本地环境进行所有开发
   - 使用测试数据库进行测试

3. **本地测试**
   - 在本地环境进行功能测试
   - 进行适当的并发测试（限制并发数）

4. **代码审查**
   - 检查连接管理是否正确
   - 确保没有连接泄漏风险

5. **提交代码**
   - 确认代码质量
   - 提交到版本控制

6. **生产环境验证**
   - 部署后观察连接数
   - 测试关键功能是否正常
   - 监控日志是否有错误
   - **不要进行大量测试**

## ⚡ 快速参考

### 必须遵守的规则

1. **永远不要对生产环境进行大量测试**
2. **使用独立的测试数据库进行开发**
3. **确保每个数据库连接都被正确释放**
4. **测试时限制并发数**
5. **异常情况下也要释放连接**

### 测试限制

- **本地测试**：可以适当并发，但也要注意限制
- **生产环境测试**：严格限制并发数（< 5）
- **压力测试**：只能在本地环境进行

### 数据库选择

- **开发环境**：使用任何你熟悉的数据库，关键是独立
- **测试环境**：使用独立的测试数据库
- **生产环境**：不要用于开发或测试

## 🎯 总结

**核心要点**：

1. **永远不要对生产环境进行大量测试**
   - 这是最重要的原则
   - 一次不当的测试就可能导致服务卡死

2. **使用独立的测试数据库**
   - 开发、测试、生产环境必须分离
   - 不要在生产数据库上进行任何开发操作

3. **正确管理数据库连接**
   - 每个连接都要在使用后释放
   - 异常情况下也要确保释放
   - 避免长时间持有连接

4. **测试时限制并发数**
   - 本地测试也要注意限制
   - 生产环境测试必须严格限制

5. **代码审查时检查连接管理**
   - 确保没有连接泄漏风险
   - 确保异常处理正确

**记住**：
- 一次不当的大量测试请求，就可能导致生产环境数据库连接耗尽
- 服务卡死会影响所有用户，后果严重
- 开发时请务必使用本地环境，保护生产数据库
- 无论你使用什么技术栈、什么数据库，这些原则都适用

**保护生产环境，从正确开发开始！**
