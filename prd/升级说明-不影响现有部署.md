# AI简报功能升级说明 - 不影响现有部署

## ✅ 向后兼容保证

本次升级**完全向后兼容**，不会影响你现有的Railway部署。

### 原有功能保持不变

1. **启动逻辑**：保持原有逻辑不变
   - 原有：`python main.py -job True` + 配置文件 `server.enable_job: True`
   - 现在：**完全一样**，只是新增了环境变量支持作为额外选项

2. **定时任务**：原有启动方式继续有效
   - 如果使用 `start.sh`（Docker）：`python3 main.py -job True -init True` ✅
   - 如果使用配置文件：`server.enable_job: True` ✅
   - 如果使用命令行参数：`python main.py -job True` ✅

3. **新增功能**：环境变量支持（可选）
   - 如果设置了 `ENABLE_JOB=True` 环境变量，也可以启用定时任务
   - **但不影响原有逻辑**，原有方式仍然有效

## 📝 改动说明

### main.py 改动

**改动前**：
```python
if cfg.args.job == "True" and cfg.get("server.enable_job", False):
    # 启动定时任务
```

**改动后**：
```python
# 保持原有逻辑
enable_job_original = cfg.args.job == "True" and cfg.get("server.enable_job", False)
# 新增环境变量支持（可选）
enable_job_by_env = os.getenv("ENABLE_JOB", "").lower() == "true"
# 任一满足即可（向后兼容）
if enable_job_by_env or enable_job_original:
    # 启动定时任务
```

**影响分析**：
- ✅ 如果原来使用 `-job True` + `server.enable_job: True`：**完全不受影响**
- ✅ 如果原来使用 `start.sh`（包含 `-job True`）：**完全不受影响**
- ✅ 如果原来只设置了配置文件：**完全不受影响**
- ✅ 新增：如果只设置环境变量 `ENABLE_JOB=True`：**也可以工作**（新功能）

### 新增文件（不影响现有部署）

以下文件是**新增的**，不影响现有功能：

1. `core/models/brief.py` - 新的数据模型
2. `core/ai/brief_generator.py` - AI服务（新功能）
3. `jobs/brief.py` - 简报生成任务（新功能）
4. `schemas/brief_migration.sql` - 数据库迁移脚本（需要手动执行）
5. `apis/article.py` - 新增了3个API接口（不影响原有接口）

### 修改的文件

1. `core/models/__init__.py` - 添加Brief导入（不影响原有模型）
2. `jobs/__init__.py` - 添加brief导入（不影响原有任务）
3. `jobs/mps.py` - 在 `start_all_task()` 中添加简报任务（不影响原有任务）
4. `apis/article.py` - 新增接口，原有接口不变
5. `config.example.yaml` - 添加AI配置项（可选，不影响原有配置）

## 🚀 升级步骤（不影响现有部署）

### 1. 代码部署

直接推送代码到GitHub，Railway会自动部署：
- ✅ 原有功能继续正常工作
- ✅ 定时任务继续正常运行
- ✅ 所有API接口继续正常工作

### 2. 数据库迁移（新增功能需要）

如果需要使用AI简报功能，需要执行数据库迁移：

```sql
-- 执行 schemas/brief_migration.sql 中的SQL
-- 或者设置 INIT_DB=True 环境变量（首次部署时）
```

**注意**：如果不执行迁移，只是AI简报功能不可用，**不影响其他功能**。

### 3. 启用AI简报功能（可选）

如果不需要AI简报功能，**什么都不用做**，原有功能继续工作。

如果需要启用AI简报功能，添加环境变量：

```bash
# 启用AI简报功能（可选）
AI_BRIEF_ENABLED=True
AI_BRIEF_AUTO_GENERATE=True
GLM_API_KEY=your-api-key
```

## ⚠️ 重要说明

### 1. 不需要修改现有配置

- ✅ 不需要修改Railway的启动命令
- ✅ 不需要修改环境变量（除非要启用AI简报）
- ✅ 不需要修改配置文件

### 2. 原有功能完全不受影响

- ✅ 文章抓取功能：正常
- ✅ 定时任务功能：正常
- ✅ 所有API接口：正常
- ✅ 前端功能：正常

### 3. 新功能默认关闭

- AI简报功能默认是**关闭**的
- 需要显式设置 `AI_BRIEF_ENABLED=True` 才会启用
- 即使不启用，也不影响任何现有功能

## 🔍 验证升级

升级后，检查以下内容确认一切正常：

1. **服务启动**：查看Railway日志，确认服务正常启动
2. **定时任务**：确认原有定时任务继续运行
3. **API接口**：测试原有API接口是否正常
4. **新功能**（可选）：如果启用了AI简报，测试新接口

## 📞 如有问题

如果升级后遇到任何问题：

1. 检查Railway日志
2. 确认环境变量设置正确
3. 确认数据库连接正常
4. 回滚到上一个版本（如果需要）

---

**总结**：本次升级完全向后兼容，不会影响你现有的Railway部署。新功能默认关闭，需要显式启用才会生效。

